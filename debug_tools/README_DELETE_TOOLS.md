# 任务数据删除调试工具使用指南

本目录包含了用于删除与 `task_times_id` 相关联数据的调试工具，支持 SQLite 和 MySQL 数据库。

## 工具概览

### 1. `delete_task_data.py` - 交互式删除工具
**功能**: 提供交互式界面，逐步引导用户完成删除操作
**适用场景**: 初次使用、需要详细确认的场景

### 2. `quick_delete_task.py` - 命令行快速删除工具
**功能**: 支持命令行参数，适合脚本化操作
**适用场景**: 自动化脚本、快速删除单个任务

### 3. `batch_delete_tasks.py` - 批量删除工具
**功能**: 从文件读取多个任务ID，支持批量删除
**适用场景**: 需要删除大量任务数据的场景

## 涉及的数据表

所有工具都会处理以下包含 `task_times_id` 字段的表：

### B站相关表
- `bilibili_video` - B站视频数据
- `bilibili_video_comment` - B站视频评论
- `bilibili_up_info` - B站UP主信息
- `bilibili_contact_info` - B站联系信息
- `bilibili_up_dynamic` - B站UP主动态

### 抖音相关表
- `douyin_aweme` - 抖音视频数据
- `douyin_aweme_comment` - 抖音视频评论
- `dy_creator` - 抖音创作者信息

### 快手相关表
- `kuaishou_video` - 快手视频数据
- `kuaishou_video_comment` - 快手视频评论

### 微博相关表
- `weibo_note` - 微博内容
- `weibo_note_comment` - 微博评论
- `weibo_creator` - 微博创作者信息

### 小红书相关表
- `xhs_note` - 小红书笔记
- `xhs_note_comment` - 小红书评论
- `xhs_creator` - 小红书创作者信息

### 贴吧相关表
- `tieba_note` - 贴吧帖子
- `tieba_comment` - 贴吧评论
- `tieba_creator` - 贴吧用户信息

### 知乎相关表
- `zhihu_content` - 知乎内容
- `zhihu_comment` - 知乎评论
- `zhihu_creator` - 知乎创作者信息

### 任务管理表
- `crawler_tasks` - 爬虫任务记录

## 详细使用说明

### 1. 交互式删除工具 (`delete_task_data.py`)

#### 基本使用
```bash
cd debug_tools
python delete_task_data.py
```

#### 操作流程
1. 选择数据库类型（SQLite/MySQL）
2. 输入要删除的 `task_times_id`
3. 选择操作模式（预览/删除）
4. 确认操作（删除模式需要二次确认）
5. 查看删除结果和统计信息

#### 示例输出
```
任务数据删除调试工具
==============================

请选择数据库类型:
1. SQLite
2. MySQL
请输入选择 (1/2): 1

请输入task_times_id: 20240101_123456

请选择操作模式:
1. 预览模式 (只查看，不删除)
2. 删除模式 (实际删除数据)
请输入选择 (1/2): 1

==================================================
SQLite数据库 - 任务ID: 20240101_123456
==================================================
○ 预览表 douyin_aweme              记录数:     15
○ 预览表 douyin_aweme_comment       记录数:    128
○ 预览表 dy_creator                 记录数:      3
○ 预览表 crawler_tasks              记录数:      1

○ 预览完成! 总计将删除 147 条记录

============================================================
删除统计摘要
============================================================
crawler_tasks                       1 条
douyin_aweme                       15 条
douyin_aweme_comment              128 条
dy_creator                          3 条
------------------------------------------------------------
总计                              147 条
============================================================
```

### 2. 命令行快速删除工具 (`quick_delete_task.py`)

#### 基本语法
```bash
python quick_delete_task.py --db <数据库类型> --task-id <任务ID> <操作模式> [选项]
```

#### 参数说明
- `--db`: 数据库类型，可选值：`sqlite` 或 `mysql`
- `--task-id`: 要删除的任务ID
- `--preview`: 预览模式，只查看不删除
- `--delete`: 删除模式，实际删除数据
- `--force`: 强制删除，跳过确认提示

#### 使用示例

**预览SQLite中的数据**
```bash
python quick_delete_task.py --db sqlite --task-id 20240101_123456 --preview
```

**删除MySQL中的数据（需要确认）**
```bash
python quick_delete_task.py --db mysql --task-id 20240101_123456 --delete
```

**强制删除（跳过确认）**
```bash
python quick_delete_task.py --db sqlite --task-id 20240101_123456 --delete --force
```

#### 查看帮助
```bash
python quick_delete_task.py --help
```

### 3. 批量删除工具 (`batch_delete_tasks.py`)

#### 准备任务ID文件
创建一个文本文件（如 `task_ids.txt`），每行一个任务ID：

```text
# 需要删除的任务ID列表
# 这是注释行，会被忽略
20240101_123456
20240102_234567
20240103_345678

# 可以添加空行和注释
20240104_456789
```

#### 基本语法
```bash
python batch_delete_tasks.py --db <数据库类型> --file <文件路径> <操作模式> [选项]
```

#### 参数说明
- `--db`: 数据库类型，可选值：`sqlite` 或 `mysql`
- `--file`: 包含任务ID列表的文件路径
- `--preview`: 预览模式，只查看不删除
- `--delete`: 删除模式，实际删除数据
- `--force`: 强制删除，跳过确认提示
- `--max-concurrent`: 最大并发删除数量（默认：3）

#### 使用示例

**预览批量删除**
```bash
python batch_delete_tasks.py --db sqlite --file task_ids.txt --preview
```

**执行批量删除**
```bash
python batch_delete_tasks.py --db mysql --file task_ids.txt --delete
```

**高并发批量删除**
```bash
python batch_delete_tasks.py --db sqlite --file task_ids.txt --delete --max-concurrent 5
```

#### 示例输出
```
找到 4 个任务ID:
   1. 20240101_123456
   2. 20240102_234567
   3. 20240103_345678
   4. 20240104_456789

============================================================
开始批量处理 - 数据库: SQLITE, 模式: 删除
============================================================

开始处理任务: 20240101_123456
开始处理任务: 20240102_234567
开始处理任务: 20240103_345678
...

============================================================
批量处理完成
============================================================
总任务数: 4
成功: 4
失败: 0

============================================================
汇总统计信息
============================================================
crawler_tasks                       4 条
douyin_aweme                       45 条
douyin_aweme_comment              312 条
dy_creator                          8 条
------------------------------------------------------------
总计                              369 条
============================================================
```

## 安全特性

### 1. 数据验证
- 自动检查表是否存在
- 验证表中是否包含 `task_times_id` 字段
- 使用参数化查询防止SQL注入

### 2. 容错机制
- 单个表删除失败不影响其他表的操作
- 详细的错误日志记录
- 异常处理和恢复机制

### 3. 确认机制
- 删除模式需要用户确认
- 支持 `--force` 参数跳过确认（适合自动化脚本）
- 预览模式让用户先查看影响范围

## 注意事项

### 1. 数据库配置
确保项目的数据库配置正确：
- SQLite: 检查数据库文件路径
- MySQL: 检查连接参数（host、port、user、password、database）

### 2. 权限要求
- SQLite: 需要对数据库文件的读写权限
- MySQL: 需要对相关表的 DELETE 权限

### 3. 备份建议
在执行删除操作前，建议：
- 备份重要数据
- 先使用预览模式查看影响范围
- 在测试环境中验证脚本功能

### 4. 性能考虑
- 批量删除时注意并发数设置
- 大量数据删除可能需要较长时间
- 建议在业务低峰期执行

## 故障排除

### 常见错误及解决方案

**1. 数据库连接失败**
```
错误: MySQL连接失败: (2003, "Can't connect to MySQL server")
```
解决方案：检查数据库配置和网络连接

**2. 文件不存在**
```
错误: 文件 'task_ids.txt' 不存在
```
解决方案：检查文件路径是否正确

**3. 权限不足**
```
错误: (1142, "DELETE command denied to user")
```
解决方案：确保数据库用户有足够的删除权限

**4. 依赖缺失**
```
请安装必要的依赖: pip install aiosqlite aiomysql
```
解决方案：安装所需的Python包

## 开发和扩展

如需扩展功能，可以：
1. 修改 `TaskDataDeleter` 类添加新的表
2. 增加新的删除策略
3. 添加更多的统计和报告功能
4. 集成到现有的管理界面中

## 版本历史

- v1.0: 初始版本，支持基本的删除功能
- 包含交互式、命令行和批量删除三种工具
- 支持SQLite和MySQL数据库
- 提供预览和删除两种模式